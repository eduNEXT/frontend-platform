{"version":3,"file":"SegmentAnalyticsService.js","names":["formurlencoded","snakeCaseObject","SegmentAnalyticsService","constructor","_ref","httpClient","loggingService","config","trackingLogApiUrl","LMS_BASE_URL","segmentKey","SEGMENT_KEY","hasIdentifyBeenCalled","segmentInitialized","initializeSegment","global","analytics","initialize","invoked","methods","factory","method","_len","arguments","length","args","Array","_key","unshift","push","forEach","key","load","options","script","document","createElement","type","onerror","event","Event","dispatchEvent","async","src","first","getElementsByTagName","parentNode","insertBefore","_loadOptions","SNIPPET_VERSION","checkIdentifyCalled","logError","sendTrackingLogEvent","eventName","properties","snakeEventData","deep","serverData","event_type","JSON","stringify","page","location","href","post","headers","catch","error","identifyAuthenticatedUser","userId","traits","Error","identify","identifyAnonymousUser","Promise","resolve","reject","ready","user","id","reset","addEventListener","setTimeout","ga","create","google_tag_manager","sendTrackEvent","track","sendPageEvent","category","name"],"sources":["../../src/analytics/SegmentAnalyticsService.js"],"sourcesContent":["import formurlencoded from 'form-urlencoded';\nimport { snakeCaseObject } from '../utils';\n\n/**\n * @implements {AnalyticsService}\n * @memberof module:Analytics\n */\nclass SegmentAnalyticsService {\n  constructor({ httpClient, loggingService, config }) {\n    this.loggingService = loggingService;\n    this.httpClient = httpClient;\n    this.trackingLogApiUrl = `${config.LMS_BASE_URL}/event`;\n    this.segmentKey = config.SEGMENT_KEY;\n    this.hasIdentifyBeenCalled = false;\n    this.segmentInitialized = false;\n\n    if (this.segmentKey) {\n      this.initializeSegment();\n    }\n  }\n\n  // The code in this function is from Segment's website, with a few updates:\n  // - It uses the segmentKey from the SegmentAnalyticsService instance.\n  // - It also saves a \"segmentInitialized\" variable on the SegmentAnalyticsService instance so\n  //   that the service can keep track of its own initialization state.\n  // Reference:\n  // https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/quickstart/\n  initializeSegment() {\n    // Create a queue, but don't obliterate an existing one!\n    global.analytics = global.analytics || [];\n    const { analytics } = global;\n\n    // If the real analytics.js is already on the page return.\n    if (analytics.initialize) {\n      this.segmentInitialized = true;\n      return;\n    }\n\n    // If the snippet was invoked do nothing.\n    if (analytics.invoked) {\n      this.segmentInitialized = true;\n      return;\n    }\n\n    // Invoked flag, to make sure the snippet\n    // is never invoked twice.\n    analytics.invoked = true;\n\n    // A list of the methods in Analytics.js to stub.\n    analytics.methods = [\n      'trackSubmit',\n      'trackClick',\n      'trackLink',\n      'trackForm',\n      'pageview',\n      'identify',\n      'reset',\n      'group',\n      'track',\n      'ready',\n      'alias',\n      'debug',\n      'page',\n      'once',\n      'off',\n      'on',\n    ];\n\n    // Define a factory to create stubs. These are placeholders\n    // for methods in Analytics.js so that you never have to wait\n    // for it to load to actually record data. The `method` is\n    // stored as the first argument, so we can replay the data.\n    analytics.factory = method => ((...args) => {\n      args.unshift(method);\n      analytics.push(args);\n      return analytics;\n    });\n\n    // For each of our methods, generate a queueing stub.\n    analytics.methods.forEach((key) => {\n      analytics[key] = analytics.factory(key);\n    });\n\n    // Define a method to load Analytics.js from our CDN,\n    // and that will be sure to only ever load it once.\n    analytics.load = (key, options) => {\n      // Create an async script element based on your key.\n      const script = document.createElement('script');\n      script.type = 'text/javascript';\n      script.onerror = () => {\n        this.segmentInitialized = false;\n        const event = new Event('segmentFailed');\n        document.dispatchEvent(event);\n      };\n      script.async = true;\n      script.src = `https://cdn.segment.com/analytics.js/v1/${key}/analytics.min.js`;\n\n      // Insert our script next to the first script element.\n      const first = document.getElementsByTagName('script')[0];\n      first.parentNode.insertBefore(script, first);\n      analytics._loadOptions = options; // eslint-disable-line no-underscore-dangle\n\n      this.segmentInitialized = true;\n    };\n\n    // Add a version to keep track of what's in the wild.\n    analytics.SNIPPET_VERSION = '4.1.0';\n\n    // Load Analytics.js with your key, which will automatically\n    // load the tools you've enabled for your account. Boosh!\n    analytics.load(this.segmentKey);\n  }\n\n  /**\n   * Checks that identify was first called.  Otherwise, logs error.\n   *\n   */\n  checkIdentifyCalled() {\n    if (!this.hasIdentifyBeenCalled) {\n      this.loggingService.logError('Identify must be called before other tracking events.');\n    }\n  }\n\n  /**\n   * Logs events to tracking log and downstream.\n   * For tracking log event documentation, see\n   * https://openedx.atlassian.net/wiki/spaces/AN/pages/13205895/Event+Design+and+Review+Process\n   *\n   * @param {string} eventName (event_type on backend, but named to match Segment api)\n   * @param {Object} properties (event on backend, but named properties to match Segment api)\n   * @returns {Promise} The promise returned by HttpClient.post.\n   */\n  sendTrackingLogEvent(eventName, properties) {\n    const snakeEventData = snakeCaseObject(properties, { deep: true });\n    const serverData = {\n      event_type: eventName,\n      event: JSON.stringify(snakeEventData),\n      page: global.location.href,\n    };\n    return this.httpClient.post(\n      this.trackingLogApiUrl,\n      formurlencoded(serverData),\n      {\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n      },\n    ).catch((error) => {\n      this.loggingService.logError(error);\n    });\n  }\n\n  /**\n   * * Send identify call to Segment.\n   *\n   * @param {string} userId\n   * @param {*} [traits]\n   */\n  identifyAuthenticatedUser(userId, traits) {\n    if (!userId) {\n      throw new Error('UserId is required for identifyAuthenticatedUser.');\n    }\n\n    if (!this.segmentInitialized) {\n      return;\n    }\n    global.analytics.identify(userId, traits);\n    this.hasIdentifyBeenCalled = true;\n  }\n\n  /**\n   * Send anonymous identify call to Segment's identify.\n   *\n   * @param {*} [traits]\n   * @returns {Promise} Promise that will resolve once the document readyState is complete\n   */\n  identifyAnonymousUser(traits) { // eslint-disable-line no-unused-vars\n    if (!this.segmentInitialized) {\n      return Promise.resolve();\n    }\n    // if we do not have an authenticated user (indicated by being in this method),\n    // but we still have a user id associated in segment, reset the local segment state\n    // This has to be wrapped in the analytics.ready() callback because the analytics.user()\n    // function isn't available until the analytics.js package has finished initializing.\n    return new Promise((resolve, reject) => { // eslint-disable-line no-unused-vars\n      global.analytics.ready(() => {\n        if (global.analytics.user().id()) {\n          global.analytics.reset();\n        }\n        // We donâ€™t need to call `identify` for anonymous users and can just make the value of\n        // hasIdentifyBeenCalled true. Segment automatically assigns them an anonymousId, so\n        // just calling `page` and `track` works fine without identify.\n        this.hasIdentifyBeenCalled = true;\n        resolve();\n      });\n\n      // this is added to handle a specific use-case where if a user has blocked the analytics\n      // tools in their browser, this promise does not get resolved and user sees a blank\n      // page. Dispatching this event in script.onerror callback in analytics.load.\n      document.addEventListener('segmentFailed', resolve);\n      // This is added to handle the google analytics blocked case which is injected into\n      // the DOM by segment.min.js.\n      setTimeout(() => {\n        if (!global.ga || !global.ga.create || !global.google_tag_manager) {\n          this.segmentInitialized = false;\n          resolve();\n        }\n      }, 2000);\n    });\n  }\n\n  /**\n   * Sends a track event to Segment and downstream.\n   * Note: For links and forms, you should use trackLink and trackForm instead.\n   *\n   * @param {*} eventName\n   * @param {*} [properties]\n   */\n  sendTrackEvent(eventName, properties) {\n    if (!this.segmentInitialized) {\n      return;\n    }\n    this.checkIdentifyCalled();\n    global.analytics.track(eventName, properties);\n  }\n\n  /**\n   * Sends a page event to Segment and downstream.\n   *\n   * @param {*} [name] If only one string arg provided, assumed to be name.\n   * @param {*} [category] Name is required to pass a category.\n   * @param {*} [properties]\n   */\n  sendPageEvent(category, name, properties) {\n    if (!this.segmentInitialized) {\n      return;\n    }\n    this.checkIdentifyCalled();\n    global.analytics.page(category, name, properties);\n  }\n}\n\nexport default SegmentAnalyticsService;\n"],"mappings":"AAAA,OAAOA,cAAc,MAAM,iBAAiB;AAC5C,SAASC,eAAe,QAAQ,UAAU;;AAE1C;AACA;AACA;AACA;AACA,MAAMC,uBAAuB,CAAC;EAC5BC,WAAWA,CAAAC,IAAA,EAAyC;IAAA,IAAxC;MAAEC,UAAU;MAAEC,cAAc;MAAEC;IAAO,CAAC,GAAAH,IAAA;IAChD,IAAI,CAACE,cAAc,GAAGA,cAAc;IACpC,IAAI,CAACD,UAAU,GAAGA,UAAU;IAC5B,IAAI,CAACG,iBAAiB,GAAI,GAAED,MAAM,CAACE,YAAa,QAAO;IACvD,IAAI,CAACC,UAAU,GAAGH,MAAM,CAACI,WAAW;IACpC,IAAI,CAACC,qBAAqB,GAAG,KAAK;IAClC,IAAI,CAACC,kBAAkB,GAAG,KAAK;IAE/B,IAAI,IAAI,CAACH,UAAU,EAAE;MACnB,IAAI,CAACI,iBAAiB,CAAC,CAAC;IAC1B;EACF;;EAEA;EACA;EACA;EACA;EACA;EACA;EACAA,iBAAiBA,CAAA,EAAG;IAClB;IACAC,MAAM,CAACC,SAAS,GAAGD,MAAM,CAACC,SAAS,IAAI,EAAE;IACzC,MAAM;MAAEA;IAAU,CAAC,GAAGD,MAAM;;IAE5B;IACA,IAAIC,SAAS,CAACC,UAAU,EAAE;MACxB,IAAI,CAACJ,kBAAkB,GAAG,IAAI;MAC9B;IACF;;IAEA;IACA,IAAIG,SAAS,CAACE,OAAO,EAAE;MACrB,IAAI,CAACL,kBAAkB,GAAG,IAAI;MAC9B;IACF;;IAEA;IACA;IACAG,SAAS,CAACE,OAAO,GAAG,IAAI;;IAExB;IACAF,SAAS,CAACG,OAAO,GAAG,CAClB,aAAa,EACb,YAAY,EACZ,WAAW,EACX,WAAW,EACX,UAAU,EACV,UAAU,EACV,OAAO,EACP,OAAO,EACP,OAAO,EACP,OAAO,EACP,OAAO,EACP,OAAO,EACP,MAAM,EACN,MAAM,EACN,KAAK,EACL,IAAI,CACL;;IAED;IACA;IACA;IACA;IACAH,SAAS,CAACI,OAAO,GAAGC,MAAM,IAAK,YAAa;MAAA,SAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAATC,IAAI,OAAAC,KAAA,CAAAJ,IAAA,GAAAK,IAAA,MAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA;QAAJF,IAAI,CAAAE,IAAA,IAAAJ,SAAA,CAAAI,IAAA;MAAA;MACrCF,IAAI,CAACG,OAAO,CAACP,MAAM,CAAC;MACpBL,SAAS,CAACa,IAAI,CAACJ,IAAI,CAAC;MACpB,OAAOT,SAAS;IAClB,CAAE;;IAEF;IACAA,SAAS,CAACG,OAAO,CAACW,OAAO,CAAEC,GAAG,IAAK;MACjCf,SAAS,CAACe,GAAG,CAAC,GAAGf,SAAS,CAACI,OAAO,CAACW,GAAG,CAAC;IACzC,CAAC,CAAC;;IAEF;IACA;IACAf,SAAS,CAACgB,IAAI,GAAG,CAACD,GAAG,EAAEE,OAAO,KAAK;MACjC;MACA,MAAMC,MAAM,GAAGC,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;MAC/CF,MAAM,CAACG,IAAI,GAAG,iBAAiB;MAC/BH,MAAM,CAACI,OAAO,GAAG,MAAM;QACrB,IAAI,CAACzB,kBAAkB,GAAG,KAAK;QAC/B,MAAM0B,KAAK,GAAG,IAAIC,KAAK,CAAC,eAAe,CAAC;QACxCL,QAAQ,CAACM,aAAa,CAACF,KAAK,CAAC;MAC/B,CAAC;MACDL,MAAM,CAACQ,KAAK,GAAG,IAAI;MACnBR,MAAM,CAACS,GAAG,GAAI,2CAA0CZ,GAAI,mBAAkB;;MAE9E;MACA,MAAMa,KAAK,GAAGT,QAAQ,CAACU,oBAAoB,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;MACxDD,KAAK,CAACE,UAAU,CAACC,YAAY,CAACb,MAAM,EAAEU,KAAK,CAAC;MAC5C5B,SAAS,CAACgC,YAAY,GAAGf,OAAO,CAAC,CAAC;;MAElC,IAAI,CAACpB,kBAAkB,GAAG,IAAI;IAChC,CAAC;;IAED;IACAG,SAAS,CAACiC,eAAe,GAAG,OAAO;;IAEnC;IACA;IACAjC,SAAS,CAACgB,IAAI,CAAC,IAAI,CAACtB,UAAU,CAAC;EACjC;;EAEA;AACF;AACA;AACA;EACEwC,mBAAmBA,CAAA,EAAG;IACpB,IAAI,CAAC,IAAI,CAACtC,qBAAqB,EAAE;MAC/B,IAAI,CAACN,cAAc,CAAC6C,QAAQ,CAAC,uDAAuD,CAAC;IACvF;EACF;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEC,oBAAoBA,CAACC,SAAS,EAAEC,UAAU,EAAE;IAC1C,MAAMC,cAAc,GAAGtD,eAAe,CAACqD,UAAU,EAAE;MAAEE,IAAI,EAAE;IAAK,CAAC,CAAC;IAClE,MAAMC,UAAU,GAAG;MACjBC,UAAU,EAAEL,SAAS;MACrBd,KAAK,EAAEoB,IAAI,CAACC,SAAS,CAACL,cAAc,CAAC;MACrCM,IAAI,EAAE9C,MAAM,CAAC+C,QAAQ,CAACC;IACxB,CAAC;IACD,OAAO,IAAI,CAAC1D,UAAU,CAAC2D,IAAI,CACzB,IAAI,CAACxD,iBAAiB,EACtBR,cAAc,CAACyD,UAAU,CAAC,EAC1B;MACEQ,OAAO,EAAE;QACP,cAAc,EAAE;MAClB;IACF,CACF,CAAC,CAACC,KAAK,CAAEC,KAAK,IAAK;MACjB,IAAI,CAAC7D,cAAc,CAAC6C,QAAQ,CAACgB,KAAK,CAAC;IACrC,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;AACA;AACA;AACA;EACEC,yBAAyBA,CAACC,MAAM,EAAEC,MAAM,EAAE;IACxC,IAAI,CAACD,MAAM,EAAE;MACX,MAAM,IAAIE,KAAK,CAAC,mDAAmD,CAAC;IACtE;IAEA,IAAI,CAAC,IAAI,CAAC1D,kBAAkB,EAAE;MAC5B;IACF;IACAE,MAAM,CAACC,SAAS,CAACwD,QAAQ,CAACH,MAAM,EAAEC,MAAM,CAAC;IACzC,IAAI,CAAC1D,qBAAqB,GAAG,IAAI;EACnC;;EAEA;AACF;AACA;AACA;AACA;AACA;EACE6D,qBAAqBA,CAACH,MAAM,EAAE;IAAE;IAC9B,IAAI,CAAC,IAAI,CAACzD,kBAAkB,EAAE;MAC5B,OAAO6D,OAAO,CAACC,OAAO,CAAC,CAAC;IAC1B;IACA;IACA;IACA;IACA;IACA,OAAO,IAAID,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MAAE;MACxC7D,MAAM,CAACC,SAAS,CAAC6D,KAAK,CAAC,MAAM;QAC3B,IAAI9D,MAAM,CAACC,SAAS,CAAC8D,IAAI,CAAC,CAAC,CAACC,EAAE,CAAC,CAAC,EAAE;UAChChE,MAAM,CAACC,SAAS,CAACgE,KAAK,CAAC,CAAC;QAC1B;QACA;QACA;QACA;QACA,IAAI,CAACpE,qBAAqB,GAAG,IAAI;QACjC+D,OAAO,CAAC,CAAC;MACX,CAAC,CAAC;;MAEF;MACA;MACA;MACAxC,QAAQ,CAAC8C,gBAAgB,CAAC,eAAe,EAAEN,OAAO,CAAC;MACnD;MACA;MACAO,UAAU,CAAC,MAAM;QACf,IAAI,CAACnE,MAAM,CAACoE,EAAE,IAAI,CAACpE,MAAM,CAACoE,EAAE,CAACC,MAAM,IAAI,CAACrE,MAAM,CAACsE,kBAAkB,EAAE;UACjE,IAAI,CAACxE,kBAAkB,GAAG,KAAK;UAC/B8D,OAAO,CAAC,CAAC;QACX;MACF,CAAC,EAAE,IAAI,CAAC;IACV,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;EACEW,cAAcA,CAACjC,SAAS,EAAEC,UAAU,EAAE;IACpC,IAAI,CAAC,IAAI,CAACzC,kBAAkB,EAAE;MAC5B;IACF;IACA,IAAI,CAACqC,mBAAmB,CAAC,CAAC;IAC1BnC,MAAM,CAACC,SAAS,CAACuE,KAAK,CAAClC,SAAS,EAAEC,UAAU,CAAC;EAC/C;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;EACEkC,aAAaA,CAACC,QAAQ,EAAEC,IAAI,EAAEpC,UAAU,EAAE;IACxC,IAAI,CAAC,IAAI,CAACzC,kBAAkB,EAAE;MAC5B;IACF;IACA,IAAI,CAACqC,mBAAmB,CAAC,CAAC;IAC1BnC,MAAM,CAACC,SAAS,CAAC6C,IAAI,CAAC4B,QAAQ,EAAEC,IAAI,EAAEpC,UAAU,CAAC;EACnD;AACF;AAEA,eAAepD,uBAAuB","ignoreList":[]}